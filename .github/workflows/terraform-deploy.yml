name: "Infrastructure Deploy - Terraform"

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Terraform Action"
        required: true
        default: "plan"
        type: choice
        options:
          - "plan"
          - "apply"
          - "destroy"

      auto_approve:
        description: "Auto approve (skip manual approval for apply/destroy)"
        required: false
        default: false
        type: boolean

permissions:
  id-token: write # Required for AWS OIDC
  contents: read # Required for checkout

env:
  AWS_REGION: "us-east-1"
  TF_VAR_project_name: "defectdojo-mvp"

jobs:
  terraform:
    name: "Terraform ${{ inputs.action }}"
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: ./infra/terraform

    outputs:
      terraform_outputs: ${{ steps.terraform_outputs.outputs.terraform_outputs }}

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: "Configure AWS Credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubInfraRole-TerraformDeploy
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: false

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: "Terraform Format Check"
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: "Terraform Init"
        id: init
        run: |
          terraform init \
            -backend-config="bucket=sec-llm-infra-terraform-state" \
            -backend-config="key=terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="encrypt=true"

      - name: "Terraform Validate"
        id: validate
        run: terraform validate -no-color

      - name: "Terraform Plan"
        id: plan
        run: |
          if [ "${{ inputs.action }}" == "destroy" ]; then
            terraform plan -destroy -no-color -input=false \
              -var="aws_region=${{ env.AWS_REGION }}" \
              -var="db_password=${{ secrets.DB_PASSWORD }}" \
              -out=tfplan
          else
            terraform plan -no-color -input=false \
              -var="aws_region=${{ env.AWS_REGION }}" \
              -var="db_password=${{ secrets.DB_PASSWORD }}" \
              -out=tfplan
          fi
        continue-on-error: false

      - name: "Manual Approval for Apply/Destroy"
        if: |
          (inputs.action == 'apply' || inputs.action == 'destroy') && 
          inputs.auto_approve == false
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ${{ github.actor }}
          minimum-approvals: 1
          issue-title: "🚨 Manual approval required for Terraform ${{ inputs.action }}"
          issue-body: |
            ## ⚠️ Terraform ${{ inputs.action }} requires manual approval

            **Action**: `${{ inputs.action }}`
            **Triggered by**: @${{ github.actor }}

            ### Plan Summary
            Please review the Terraform plan above before approving.

            **To approve**: Comment `approved`, `approve`, `lgtm`, or `yes`
            **To deny**: Comment `denied`, `deny`, `no`, or close this issue

            ⏱️ **Timeout**: This approval will timeout in 30 minutes
          exclude-workflow-initiator-as-approver: false

      - name: "Terraform Apply"
        id: apply
        if: |
          inputs.action == 'apply' && 
          steps.plan.outcome == 'success'
        run: |
          terraform apply -auto-approve -input=false tfplan
        continue-on-error: false

      - name: "Terraform Destroy"
        id: destroy
        if: |
          inputs.action == 'destroy' && 
          steps.plan.outcome == 'success'
        run: |
          terraform apply -auto-approve -input=false tfplan
        continue-on-error: false

      - name: "Get Terraform Outputs"
        id: terraform_outputs
        if: inputs.action == 'apply' && steps.apply.outcome == 'success'
        run: |
          # Export all terraform outputs as JSON for other workflows
          terraform output -json > terraform_outputs.json
          echo "terraform_outputs=$(cat terraform_outputs.json | jq -c .)" >> $GITHUB_OUTPUT

      - name: "Terraform Output"
        id: output
        if: inputs.action == 'apply' && steps.apply.outcome == 'success'
        run: |
          echo "## Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform output >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: "Upload Terraform Plan Artifact"
        uses: actions/upload-artifact@v4
        if: steps.plan.outcome == 'success'
        with:
          name: terraform-plan-${{ github.run_number }}
          path: |
            terraform/tfplan
            terraform/.terraform.lock.hcl
          retention-days: 30

      - name: "Clean up on failure"
        if: failure()
        run: |
          echo "🚨 Workflow failed. Cleaning up..."
          rm -f tfplan
          echo "::error::Terraform ${{ inputs.action }} failed. Check the logs above."

      - name: "Success Notification"
        if: success()
        run: |
          echo "✅ Terraform ${{ inputs.action }} completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resources Created/Updated**: Check outputs above" >> $GITHUB_STEP_SUMMARY
